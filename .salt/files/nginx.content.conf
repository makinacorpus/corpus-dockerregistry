{% set cfg = salt['mc_project.get_configuration'](
      salt['mc_utils.json_load'](data).project) %}
{% set data = cfg.data %}
# process registry requests whenever we get a 418 ERROR, search below
error_page 418 = @registry;

{% if data.get('force_ssl', False) %}
if ($forwarded_ssl_scheme != "https"){
    rewrite ^(.*)$ https://{{data.domain}}$1 permanent;
}
{% endif %}

{% macro auth() %}
{% if data.get('ldap_url', '') %}
auth_ldap "Restricted(ldap)";
auth_ldap_servers {{cfg.name}}auth;
{% elif not data.get('unsecured_registry', False) %}
auth_basic            "Restricted";
auth_basic_user_file  {{data.htaccess}};
{% endif %}
{% endmacro %}

#location /media/ {
#    {{auth()}}
#    alias /foo,
#}
location / {
    {{auth()}}
    return 418;
}

# invalid dot dirs
{% for location in data.get('disabled_urls', []) %}
location ~* {{location}} {
    return 404;
}
{% endfor%}

location @registry {
    {{auth()}}
    include proxy_params;
    proxy_pass http://{{cfg.name}}app;
}
